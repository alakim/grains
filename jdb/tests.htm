<html>
<head>
<meta charset="windows-1251"/>
<title>JDB Unit Tests</title>
<script type="text/javascript" src="../tools/jsUnit.js"></script>
<script type="text/javascript" src="jdb.js"></script>
<script type="text/javascript">
new JSUnit.Test("Подключение модуля JDB", "Configuration").run = function(){
	this.assert(typeof(JDB), "function");
}

new JSUnit.Test("Конструктор", "Basic").run = function(){
	var coll = [1, 2, 3];
	var d = JDB(coll);
	this.assert(d.raw(), coll);
	this.assert(JDB(d).raw(), coll); // повторная обертка не приводит к ошибкам
}

new JSUnit.Test("Map", "Basic").run = function(){
	this.assert(JDB([1, 2, 3]).map(function(x){return x*2;}).raw(), [2, 4, 6]);
	this.assert(JDB({x:1, y:2, z:3}).map(function(x){return x*2;}).raw(), {x:2, y:4, z:6});
}

new JSUnit.Test("Each", "Basic").run = function(){
	var log = [];
	this.assert(JDB([1, 2, 3]).each(function(x){log.push(x);}).raw(), [1, 2, 3]);
	this.assert(log, [1, 2, 3]);
	log = [];
	this.assert(JDB({x:1, y:2, z:3}).each(function(x, n){log.push(n+":"+x);}).raw(), {x:1, y:2, z:3});
	this.assert(log, ["x:1", "y:2", "z:3"]);
}

new JSUnit.Test("Select", "Basic").run = function(){
	this.assert(JDB([1, 2, 3]).select(function(x){return x<3;}).raw(), [1, 2]);
	this.assert(JDB({x:1, y:2, z:3}).select(function(x){return x<3;}).raw(), {x:1, y:2});
}

new JSUnit.Test("Index", "Basic").run = function(){
	var coll = [
		{id:1, nm:"John"},
		{id:2, nm:"Phill"},
		{id:3, nm:"James"}
	];
	this.assert(JDB(coll).index("id").raw(), {
		1:{id:1, nm:"John"},
		2:{id:2, nm:"Phill"},
		3:{id:3, nm:"James"}
	});
	this.assert(JDB(coll).index(function(e){return e.id;}).raw(), {
		1:{id:1, nm:"John"},
		2:{id:2, nm:"Phill"},
		3:{id:3, nm:"James"}
	});
}
new JSUnit.Test("GroupBy", "Basic").run = function(){
	var coll = [
		{salary:100, nm:"John"},
		{salary:200, nm:"Phill"},
		{salary:100, nm:"James"}
	];
	this.assert(JDB(coll).groupBy("salary").raw(), {
		100:[
			{salary:100, nm:"John"},
			{salary:100, nm:"James"}
		],
		200:[{salary:200, nm:"Phill"}],
	});
	this.assert(JDB(coll).groupBy(function(e){return e.salary;}).raw(), {
		100:[
			{salary:100, nm:"John"},
			{salary:100, nm:"James"}
		],
		200:[{salary:200, nm:"Phill"}],
	});
}

new JSUnit.Test("extend", "Basic").run = function(){
	var coll = {
		1:{id:1, nm:"John"}
	};
	this.assert(JDB(coll).extend({
		2:{id:2, nm:"Phill"},
		3:{id:3, nm:"James"}
	}).raw(), {
		1:{id:1, nm:"John"},
		2:{id:2, nm:"Phill"},
		3:{id:3, nm:"James"}
	});
}

new JSUnit.Test("ToArray", "Basic").run = function(){
	this.assert(JDB({
		1:{id:1, nm:"John"},
		2:{id:2, nm:"Phill"},
		3:{id:3, nm:"James"}
	}).toArray().raw(), [
		{id:1, nm:"John"},
		{id:2, nm:"Phill"},
		{id:3, nm:"James"}
	]);
}

new JSUnit.Test("TreeToArray", "Basic").run = function(){
	var tree = {nm:"library", children:[
		{nm:"scifi", children:[
		]},
		{nm:"classics", children:[
			{nm:"russian", children:[
				{nm:"Pushkin"},
				{nm:"Tolstoy"}
			]}
		]}
	]};
	this.assert(JDB(tree).treeToArray("children", function(e){return e.nm;}).raw(), [
		"library", "scifi", "classics", "russian", "Pushkin", "Tolstoy"
	]);
	this.assert(JDB(tree).treeToArray("children", "nm").raw(), [
		"library", "scifi", "classics", "russian", "Pushkin", "Tolstoy"
	]);
}



function init(){
	document.getElementById("versionPanel").innerHTML = JDB.version;
	JSUnit.init();
}
</script>
</head>
<body onload="init()">
	<h1>JDB Unit Tests</h1>
	<p>JDB - модуль для операций над коллекциями в формате JSON</p>
	<p>JDB v.<span id="versionPanel"></span></p>
	<div id="testContainer" style="display:none;"></div>
	<div id="out"></div>
</body>
</html>