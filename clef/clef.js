(function($,$R,$D){
	var settings = {
		staffSize: {w:500, h:24},
		offset: {x:10, y:19},
		chordOffset:{x:24, y:12},
		staffColor: "#888",
		signColor: "#000"
	};
	
	
	var signs = {
		clef: function(paper, x, y){
			var p = "m 1.683657,0.360588 c 2.2794417,-0.29563869 4.3790037,1.5872499 4.6218482,3.81564 0.4629996,2.4324376 -1.1299407,4.8643036 -3.3672782,5.76466 0.1371368,2.139788 1.0194734,4.363503 0.1708825,6.456287 -0.9005162,2.327911 -4.3859083,2.729756 -5.9012716,0.799911 -1.2083848,-1.161286 -1.1119038,-3.604943 0.641989,-4.175447 1.63624931,-0.611554 3.0501019,1.546049 2.17737418,2.918265 -0.209542,1.124698 -2.65345318,0.422208 -1.48323458,1.448279 1.5691423,1.057746 3.9502356,-0.102376 4.1858027,-1.962769 0.3109062,-1.74809 -0.2914846,-3.48891 -0.4386022,-5.225526 -3.04133585,0.81257 -6.1960743,-1.3059978 -7.2337195,-4.146674 -1.0477421,-2.4416814 -0.6262419,-5.35404727 0.9713283,-7.4598385 1.1670802,-1.6721741 2.707937,-3.0269866 4.1925337,-4.4066125 -0.41880608,-2.7520492 -0.53812498,-5.699187 0.7155575,-8.272975 0.4142731,-0.905312 1.6251047,-3.016269 2.6964914,-1.873266 1.0388169,2.020508 1.5515572,4.396776 1.2049903,6.660166 -0.4202271,2.381509 -1.7438018,4.5532753 -3.5304117,6.1617 -0.062766,1.1207489 0.292827,2.35382542 0.37543,3.4985 m -0.33251,2.3856 c -1.78730093,0.3753776 -2.9974802,2.8501171 -1.60485,4.2778 0.47022503,0.2009304 1.489679,1.3157653 0.33271,0.87 C -2.0613908,6.7734724 -2.5615185,3.6265668 -0.93155824,1.8660824 -0.36875426,0.79720876 1.6751178,0.87919813 0.920597,-0.630512 0.70374428,-1.3210546 1.0126274,-3.3324332 0.01396943,-2.0754688 -2.1456674,-0.33244958 -4.4148979,2.0457194 -4.2016228,5.0377828 -4.0433254,8.0593868 -0.68446237,10.438083 2.1959231,9.4999442 1.9458536,7.2557866 1.6265007,4.9954225 1.350717,2.746288 m 2.89237,-14.6858 c 0.1144988,-1.917884 -2.3424315,-1.555322 -2.7004039,-0.02048 -0.91528829,1.710272 -1.04437928,3.7366708 -0.7109561,5.620178 1.7414334,-1.3628551 3.3234218,-3.2939089 3.41136,-5.5997 z m -1.38543,21.2933 C 4.8127303,8.4487979 5.7159341,5.6797518 4.3012051,3.9316845 3.7893531,3.0714268 1.3930452,1.9165364 2.121348,3.7453908 2.3662189,5.6149307 2.6116172,7.4844016 2.857657,9.353788 Z";
			paper.path(p).attr({fill:settings.signColor, "stroke-width":0}).transform(["T", x+10, y+11, "S", 1.3]);
		},
		addLines: function(paper, x, y, step, offset){
			y+=3.5;
			var dX = 7;
			if(y<settings.staffSize.h){
				for(var yL = offset.y - step+.5; yL>=y; yL-=step){
					paper.path(["M", x-dX+1, yL, "L", x+dX+1, yL]).attr({stroke:settings.staffColor});
				}
			}
			else{
				for(var yL = offset.y+settings.staffSize.h + step+.5; yL<=y; yL+=step){
					paper.path(["M", x-dX+1, yL, "L", x+dX+1, yL]).attr({stroke:settings.staffColor});
				}
			}
		},
		sharp: function(paper, x, y, colorIdx){
			if(colorIdx==null) colorIdx = -1;
			var p = "M 1.342469,0.9957 C 1.1279074,1.1106353 0.73529712,1.0381921 0.64044525,1.2730548 0.66418748,1.9474552 0.64596109,2.6237134 0.65246244,3.2985715 0.35437128,3.4260789 0.20153859,3.1845131 0.29585354,2.9100731 0.32095945,2.3666195 0.30082748,1.8212812 0.307298,1.2770528 0.12076783,1.2780737 -0.26293028,1.4979286 -0.179395,1.1728574 -0.17862427,0.88269429 -0.17935411,0.59174862 -0.18274047,0.30237716 -0.0045875,0.1618023 0.44500135,0.24497878 0.32393721,-0.13168721 0.30144466,-0.55528058 0.30797322,-0.979418 0.307298,-1.4034509 c -0.1853778,0.00773 -0.56886149,0.2713095 -0.486693,-0.064529 0.004026,-0.289337 -0.008193,-0.5825039 0.006339,-0.8685234 0.27218104,-0.071654 0.60882687,-0.124824 0.48941181,-0.491868 -0.0253096,-0.5462942 0.0105614,-1.094323 -0.0259335,-1.6400535 -0.0745049,-0.214866 0.41896642,-0.2979025 0.36132633,-0.074688 0,0.6546293 0,1.3092587 0,1.963888 0.21462768,-0.1147099 0.607154,-0.042375 0.7021072,-0.2771054 -0.0234,-0.6549625 -0.00638,-1.3114324 -0.011552,-1.9670712 0.074761,-0.1498159 0.4400376,-0.094872 0.344818,0.1249129 0,0.6223539 0,1.2447078 0,1.8670617 0.1865174,-0.00105 0.5700142,-0.2217498 0.486509,0.1034574 -0.00267,0.2751959 0.0051,0.5530287 -0.00335,0.8258821 -0.2093365,0.1160309 -0.6169085,0.062756 -0.4969772,0.4272675 0.01935,0.4218194 0.012949,0.84403262 0.013866,1.2661504 0.1832539,-0.0164567 0.5676158,-0.30690592 0.486509,0.0361169 0.00235,0.28188472 -0.00811,0.56430729 0.013386,0.84540063 -0.059423,0.2414143 -0.5735044,0.0647637 -0.4998951,0.38470363 3.066e-4,0.5812826 -0.00255,1.1629032 0.00592,1.743803 C 1.6895353,2.9927957 1.236242,3.001728 1.342358,2.7522538 1.3424663,2.1667359 1.3425037,1.581218 1.342491,0.9957 M 0.65191,0.058105 c 0.22521526,-0.08023907 0.5054622,-0.07443798 0.6918286,-0.22068083 -0.00161,-0.50086937 -0.00139,-1.00590427 -0.00127,-1.50857497 -0.2253103,0.079881 -0.50550503,0.07448 -0.69182856,0.2207714 0.001611,0.50078806 0.00139,1.0059221 0.001271,1.5084844 z";
			paper.path(p).attr({fill:colorIdx<0?settings.signColor:settings.color[colorIdx], "stroke-width":0}).transform(["T", x-9.5, y+4, "S", 2]);
		},
		flat: function(paper, x, y, colorIdx){
			if(colorIdx==null) colorIdx = -1;
			var p = "m 0.78685,-0.2242889 c 0.2443889,-0.0794908 0.6674822,-0.16805839 0.55781,0.21424498 0,2.18721752 0,4.37443512 0,6.56165262 C 1.8924066,6.1312642 2.6265601,5.7072529 3.3280054,6.00001 4.0466942,6.2909718 4.4034947,7.180423 4.117818,7.8945523 3.7160184,8.9876642 2.663483,9.6075163 1.8556162,10.37124 1.5023916,10.669651 1.1057727,11.084291 0.78655,11.319407 0.78674869,7.4715083 0.78615176,3.6236089 0.78685,-0.2242886 Z M 1.34466,10.236456 C 2.0215613,9.4880697 2.8463095,8.7102176 2.944617,7.6447372 3.0121807,7.1427294 2.6424514,6.4764573 2.0656902,6.5984994 1.6535265,6.7409471 1.2623283,7.1607042 1.3436253,7.62476 c 0.0024,0.8705402 3.528e-4,1.7411381 0.00104,2.611696 z";
			paper.path(p).attr({fill:colorIdx<0?settings.signColor:settings.color[colorIdx], "stroke-width":0}).transform(["T", x-11, y-5, "S", 1.5]);
		},
		natural: function(paper, x, y, colorIdx){
			if(colorIdx==null) colorIdx = -1;
			var p = "m 0.85319,1.65318 c 0.752,-0.124 1.86,-0.676 1.86,0.238 0,1.367 0,2.735 0,4.103 0,2.514 0,5.026 0,7.538 2.797,-0.848 5.623,-1.581 8.405,-2.083 0,6.414 0,12.828 0,19.241 0,3.361 0,6.725 0,10.086 0,0.997 0.267,1.133 -0.802,1.282 -0.45,0.062 -1.058,0.377 -1.058,-0.157 0,-0.707 0,-1.415 0,-2.124 0,-3.187 0,-6.373 0,-9.56 -2.798,0.848 -5.624,1.579 -8.406,2.076 0.001,-10.213 0.001,-20.426 0.001,-30.64 m 1.86,24.784 c 0.674,-0.125 6.55,-1.41 6.545,-1.743 0,-2.466 0,-4.934 0,-7.4 -0.676,0.132 -6.551,1.428 -6.545,1.761 0,2.46 0,4.923 0,7.382";
			paper.path(p).attr({fill:colorIdx<0?settings.signColor:settings.color[colorIdx], "stroke-width":0}).transform(["T", x-14, y-18, "S", .4]);
		},
		whole: function(paper, x, y, colorIdx){
			if(colorIdx==null) colorIdx = -1;
			var p = "M 0.890558,1.1090854 C 2.076764,1.0761814 4.254094,1.8401509 4.299524,3.454775 4.351974,5.0289796 2.132717,5.8251848 0.979414,5.8004648 -0.239529,5.8316988 -2.383954,5.0688984 -2.429719,3.454775 -2.481829,1.8971062 -0.24621,1.0841987 0.890558,1.1090854 Z M 1.334675,5.3982705 C 2.040854,5.272668 2.315943,4.9122294 2.266504,3.8471154 2.184994,2.3888258 1.357057,1.339913 0.535464,1.5005904 c -0.690145,0.1433069 -0.981101,0.4477923 -0.931996,1.5129064 0.06514,1.4577884 0.909447,2.5449501 1.731207,2.3847737 z";
			paper.path(p).attr({fill:colorIdx<0?settings.signColor:settings.color[colorIdx], "stroke-width":0}).transform(["T", x, y, "S", 1.5]);
		},
		half: function(paper, x, y, colorIdx){
			if(colorIdx==null) colorIdx = -1;
			var p = "m 1.3105576,0.07516 c 0.2729632,0.03513 0.5459265,0.07477 0.8179888,0.117563 0,8.584379 0,17.168757 0,25.753136 -0.054052,2.643149 -3.3886174,5.427734 -5.9268154,5.26828 -0.763486,-0.03243 -1.533279,-0.202245 -2.140014,-0.671598 -0.971587,-0.763486 -1.177886,-1.832367 -1.148157,-2.951246 0.08513,-2.650356 3.29763,-4.596232 5.928167,-4.782261 0.761684,-0.04865 1.5269723,0.0095 2.4683802,0.562592 C 1.3105576,15.606137 1.3105576,7.840198 1.3105576,0.07516 Z M -6.102691,29.111962 c 0,0.427913 0.211704,0.5707 0.728352,0.710785 0.882401,0.153598 2.530991,-0.488271 3.904816,-1.62787 1.405355,-1.099059 2.7071102,-2.710714 2.6152216,-3.65032 -0.029729,-0.335123 -0.3292675,-0.517549 -0.6337612,-0.531963 -1.3071604,-0.163507 -3.6917604,1.540035 -4.6367714,2.263433 -1.159869,0.92294 -2.039117,1.938219 -1.977857,2.835935 z";
			paper.path(p).attr({fill:colorIdx<0?settings.signColor:settings.color[colorIdx], "stroke-width":0}).transform(["T", x+3.5, y-22, "S", .8]);
		},
		quarter: function(paper, x, y, colorIdx){
			if(colorIdx==null) colorIdx = -1;
			var p = "M 0.12463,0.287643 C 0.08025109,1.4219563 -0.816495,2.348957 -1.7860167,2.8310293 -2.6253345,3.2614165 -3.7968888,3.245469 -4.4177909,2.4512296 -4.9985689,1.7731198 -4.7219607,0.73658352 -4.1044233,0.179474 c 0.9000454,-0.90867196 2.2823733,-1.4696692 3.54408257,-1.05873947 0.35400741,0.33829936 0.23014409,-0.10922877 0.25005473,-0.35890553 0,-4.007993 0,-8.015986 0,-12.023979 0.80072835,-0.05636 0.29246304,1.023767 0.43474716,1.537907 1.6885e-4,4.0039607 1.6884e-4,8.007932 1.6884e-4,12.011886 z";
			paper.path(p).attr({fill:colorIdx<0?settings.signColor:settings.color[colorIdx], "stroke-width":0}).transform(["T", x+3.5, y-1, "S", 1.5]);
		},
		noteHead: function(paper, x, y, colorIdx){
			if(colorIdx==null) colorIdx = -1;
			var p = "m -1.716063,5.172681 c -2.5639768,1.8175766 -5.1111384,3.1629704 -8.383717,0.845233 -2.434925,-2.6708249 -0.640624,-5.52103702 1.474907,-7.146228 2.2935631,-1.451071 6.2679001,-3.1413802 8.560415,-1.35468 2.2925149,1.78670017 0.59987032,5.6629972 -1.651605,7.655675 z";
			paper.path(p).attr({fill:colorIdx<0?settings.signColor:settings.color[colorIdx], "stroke-width":0}).transform(["T", x+5.5, y+1, "S", .6]);
		},
		n2: function(paper, x, y){
			var p = "M 1.2694901,0.302889 C 0.93243351,-2.1752163 1.9068629,-4.7376911 3.7445896,-6.4205497 5.7159781,-8.359262 8.4119924,-9.2714654 10.55591,-10.97172 c 1.247106,-1.005291 1.72606,-3.000403 0.718304,-4.330316 -1.056013,-1.414389 -3.0736385,-1.583241 -4.6676428,-1.190088 -0.9469132,0.256345 -1.8925554,0.91596 -2.1942424,1.87376 0.7997707,0.122928 1.8483123,-0.233792 2.4862875,0.576336 1.073284,1.080328 0.6892888,3.065015 -0.6387029,3.764982 -1.7134894,1.0737207 -4.4280307,0.217412 -4.8776073,-1.85266 -0.64356727,-2.308222 0.6395616,-4.801466 2.6491379,-5.981912 2.6562053,-1.706519 6.056298,-1.779859 9.036616,-1.011261 2.240531,0.638867 4.366257,2.365076 4.762048,4.76317 0.463807,2.15794 -0.451256,4.5295188 -2.295924,5.7610872 -2.306511,1.6722827 -5.268957,1.861195 -7.785151,3.0908964 -1.0552404,0.4754671 -2.080564,1.1017428 -2.8005429,2.0266144 2.2242986,-1.3213154 4.9581473,-1.202895 7.3792709,-0.5675898 1.027197,0.3104112 2.697646,0.4871278 3.060535,-0.8400238 0.28515,-0.5243825 -0.125838,-1.8427856 0.78925,-1.6323864 0.734648,0 1.469296,0 2.203944,0 0.107195,2.1041961 0.0295,4.5355823 -1.589135,6.09993787 C 14.937895,1.1802039 12.175649,1.1422582 9.9828315,0.33046992 8.4385448,-0.21067576 6.8794093,-1.0953075 5.1938647,-0.88997777 4.3370711,-0.51575612 3.926079,0.67063582 2.8128588,0.30590658 2.298402,0.30655005 1.7839341,0.30727915 1.2694901,0.302889 Z";
			paper.path(p).attr({fill:settings.signColor, "stroke-width":0}).transform(["T", x, y+14, "S", .55]);
		},
		n3: function(paper, x, y){
			var p = "m 1.8336588,1.7116657 c 0,-0.88933333 0,-1.77866667 0,-2.668 1.3728814,-0.0669651 3.0940184,-0.3650468 3.6793986,-1.7923684 0.5279112,-1.3282807 -0.059824,-3.0090762 -1.4103516,-3.5767563 -1.646658,-0.7045481 -3.75784392,-0.6444272 -5.1988302,0.5012617 -0.2543873,0.3085787 1.13260461,0.022193 1.40343945,0.4495821 1.47481615,0.8920366 1.09224115,3.37029 -0.45237109,3.9798981 -1.40478676,0.60955314 -3.42528196,0.2272696 -4.04094566,-1.316001 -0.7165731,-1.8903591 0.1292081,-4.1574633 1.8226605,-5.2266159 2.30528851,-1.55244 5.2372085,-1.5898354 7.9078915,-1.3095476 2.0714181,0.2551359 4.4068803,1.0161456 5.4383067,2.9884797 0.897244,1.7757844 0.523335,4.2292532 -1.2022136,5.3718176 C 9.2704991,-0.33761891 7.7153552,-0.08004982 7.5376249,0.09097319 9.3715984,0.56456144 11.373664,1.5238901 12.010481,3.4582101 12.698973,5.6634985 11.86703,8.3227065 9.844659,9.5366657 7.5031732,10.997625 4.6364963,11.164623 1.9495729,11.089215 -0.39234915,10.975701 -3.0196863,10.285536 -4.3981162,8.2292104 -5.4275892,6.6006472 -5.3699428,4.0525141 -3.675263,2.8832907 -2.2457643,1.8927865 0.1174966,2.258585 0.8239088,3.9651657 1.3367809,5.1129584 0.89994303,6.7016174 -0.36538197,7.127923 -0.88976319,7.3693861 -2.0386125,7.2057905 -1.0129799,7.6942243 0.41635739,8.4908277 2.1807138,8.5451261 3.7401589,8.1470407 5.2034948,7.7903517 6.2070982,6.3498093 6.1435985,4.8624625 6.2531078,3.6492759 5.5338795,2.3996572 4.3293457,2.0603678 3.5305001,1.7795069 2.6744782,1.7152382 1.8336588,1.7116657 Z";
			paper.path(p).attr({fill:settings.signColor, "stroke-width":0}).transform(["T", x+6, y+4, "S", .55]);
		},
		n4: function(paper, x, y){
			var p = "m 1.3063216,0.384109 0,-2.6380005 0.853,0 c 1.003,0 1.662,-0.088 1.979,-0.264 0.315,-0.176 0.473,-0.692 0.473,-1.551 l 0,-0.125 0,-1.302 -9.246,0 0,-3.042 9.881,-10.4240005 4.7930004,0 0,10.6730005 3.087,0 0,2.793 -3.087,0 0,1.907 c 0,0.538 0.142,0.895 0.427,1.07 0.284,0.176 0.892,0.264 1.822,0.264 l 0.838,0 0,2.6380005 -11.8200004,0 z m -2.761,-8.6720005 6.065,0 0.062,-6.2350005 -6.127,6.2350005 z";
			paper.path(p).attr({fill:settings.signColor, "stroke-width":0}).transform(["T", x+5, y+15, "S", .55]);
		},
		n5: function(paper, x, y){
			var p = "m 0.0279085,1.5184114 c -0.26449467,3.1992784 -0.53821372,6.3777241 -0.85728,9.5722696 -0.3570455,1.305188 1.27172999,1.417253 1.9466766,0.666618 1.0820007,-0.552494 2.2924476,-1.068967 3.5316831,-0.947432 0.7415353,0.202406 1.436267,0.809595 1.489194,1.631532 0.048341,2.297904 0.4459402,6.164193 -0.639424,7.092642 -0.7296711,0.595769 -1.7573276,0.393686 -2.6051163,0.229535 -0.868886,-0.121456 -0.6389548,-0.89013 -0.016552,-1.189096 2.533698,-3.537017 -2.54532479,-6.047278 -4.249584,-2.910116 -0.8106179,1.452151 -0.2369099,3.369739 1.06789075,4.331092 3.55726935,2.442085 9.45422765,2.105922 11.57646335,-1.764442 0.94183,-1.883076 1.019154,-4.22864 0.1109,-6.139599 C 9.7987941,9.0902661 4.6687599,7.6734303 1.758183,9.5914254 1.3850091,9.654625 0.48974377,10.868613 0.62437376,10.109422 L 0.9089185,6.4032214 C 5.4954513,6.9062211 9.7391371,6.4138004 11.261801,1.6402855 7.5910009,2.5915804 3.3296481,1.9552134 0.0279085,1.5184114 Z";
			paper.path(p).attr({fill:settings.signColor, "stroke-width":0}).transform(["T", x+5, y-5, "S", .6]);
		},
		n6: function(paper, x, y){
			var p = "M 1.2930727,1.5087828 C 3.5876045,-0.10893709 6.727085,-0.29482357 9.2910007,0.75533749 13.591737,2.7296915 13.661991,8.4616667 10.280578,10.956599 5.1682224,14.459155 -2.1182434,12.37676 -3.86373,7.172296 -5.5883718,1.6242633 -4.1592583,-5.3555328 1.7048809,-7.318316 5.1246553,-8.2477113 11.639505,-7.8355251 11.928924,-3.8737904 12.112371,-2.459034 10.986997,-1.1128791 9.5863386,-0.95881045 8.2777538,-0.71469727 6.5831146,-1.2264878 6.225073,-2.6560592 c -0.3001605,-0.9714318 0.2008205,-2.0812034 1.166,-2.442158 -4.7669171,-1.5113717 -6.0985442,2.7095091 -6.0980003,6.607 z M 6.8241042,7.5752433 C 6.9857764,6.1038278 6.9152446,4.3287091 5.7157769,3.2856414 4.6001131,2.4038147 2.7917738,2.8002675 2.1221391,4.052484 1.3380237,5.4051839 1.3829024,7.1489739 1.9467602,8.5728611 3.3884918,10.96978 6.3872009,10.373799 6.8241042,7.5752433 Z";
			paper.path(p).attr({fill:settings.signColor, "stroke-width":0}).transform(["T", x+6, y+4, "S", .55]);
		},
		n7: function(paper, x, y){
			var p = "m -2.0563987,2.6664014 0.19836,-1.70184 -0.97883,0 -0.83239,6.24749 1.01777,0 C -2.6569987,6.4502559 -2.6763947,5.395573 -1.8174509,5.0907269 0.41802251,4.8576458 2.6185304,6.2962103 4.6100637,6.0350746 5.1282596,6.6741198 4.1611753,7.4478716 3.9326105,8.0675803 1.4838918,11.188677 -1.335323,14.237607 -1.2997411,18.86598 -1.0217034,21.204583 2.3839461,21.55917 3.6751317,20.425172 4.9189379,19.402266 4.9310673,17.643035 4.71157,16.183508 3.6742932,11.043351 5.7923465,7.1467973 7.6215935,3.4206814 7.8079421,2.7300329 8.6364608,1.4082853 7.644821,1.0238914 7.0747799,1.2010995 6.8296274,2.1855671 6.0596905,1.794522 2.8313545,0.37316913 0.65759698,-0.29157848 -2.0563987,2.6664014 Z";
			paper.path(p).attr({fill:settings.signColor, "stroke-width":0}).transform(["T", x+8, y-5, "S", .6]);
		},
		n8: function(paper, x, y){
			var p = "M 0.37526,1.93789 C -1.4546522,1.0003559 -2.8664509,-0.95694422 -2.5833857,-3.0814368 -1.787008,-8.7431243 6.2463259,-9.4932031 10.969288,-7.2959313 14.665575,-4.897815 13.835184,-1.6716547 10.218059,0.20665778 12.336488,0.9142504 14.314011,2.7947185 14.380332,5.1334955 14.711268,11.993332 6.6618146,12.475289 1.8864363,11.753827 -4.4374989,10.577782 -5.3872873,4.0154177 0.37526,1.93789 Z m 2.45,1.397 C 1.3868022,3.9051767 0.14167648,5.3929328 0.58927563,7.012265 1.54708,10.518271 8.7646881,10.211282 9.1816819,7.5890619 10.058852,5.1803395 4.9632432,4.0615331 2.82526,3.33489 Z m 4.7,-4.298 C 8.9225674,-1.5177739 9.991314,-3.3855395 8.975678,-4.7253639 5.9450928,-7.6591921 -0.26464233,-4.7653988 3.3813875,-2.5735373 4.6569759,-1.8048089 6.1084162,-1.3866735 7.52526,-0.96311 Z";
			paper.path(p).attr({fill:settings.signColor, "stroke-width":0}).transform(["T", x+5.5, y+3, "S", .55]);
		},
		n9: function(paper, x, y){
			var p = "M 0.30219,0.43782 C -2.0337783,2.1007136 -5.2636573,2.2971733 -7.8603803,1.1557989 -12.011828,-1.0043085 -12.040463,-6.5580958 -8.7173149,-9.0109085 -3.6938273,-12.154603 3.1104233,-10.838293 5.4312329,-5.2260433 7.1452793,0.28556866 5.9715757,7.2264693 -0.03270233,9.2560605 -4.0693348,10.423616 -10.071976,9.826581 -10.362638,5.8064562 -10.290611,1.8854491 -5.3082805,2.1904025 -4.6570827,4.6240551 -4.3605673,5.591043 -4.8517503,6.7007059 -5.82481,7.04482 c 4.91819299,1.4204143 6.44582392,-2.6937822 6.127,-6.607 z m -3.04,-8.547 c -3.3501833,0.2119621 -3.0522717,5.2364429 -1.3978525,6.7940767 1.1194246,0.90604656 2.9410579,0.47758244 3.6008525,-0.7893208 1.14541794,-2.2353745 0.62524239,-6.0606792 -2.203,-6.0047559 z";
			paper.path(p).attr({fill:settings.signColor, "stroke-width":0}).transform(["T", x+14, y+6, "S", .55]);
		}
	};


	
	function init(pnl, staff){
		//var offset = {x:10, y:19};
		var paper = new $R(pnl[0], settings.staffSize.w, settings.staffSize.h+settings.offset.y*2);
		var step = settings.staffSize.h/4,
			stepX = 25,
			beamSize = 20;
			
		var posX = settings.offset.x + stepX;
		
		for(var i=0; i<5; i++){
			var y = settings.offset.y + i*step;
			var p = ["M", settings.offset.x, y, "L", settings.offset.x+settings.staffSize.w, y];
			paper.path(p).attr({stroke:settings.staffColor});
		}
		signs.clef(paper, settings.offset.x, settings.offset.y);
		
		function drawSequence(seq, groupMode){
			groupMode = groupMode || false;
			
			if(!(seq instanceof Array)){
				var chords = [], groups = [];
				seq = seq.replace(/&lt;([a-g]([ei]?s|n)?'*(@\d+)? +)*[a-g]([ei]?s|n)?'*(@\d+)?&gt;\d/ig, function(x){
					var idx = chords.length;
					chords.push(x);
					return "#CH"+idx;
				});
				seq = seq.replace(/\[([^\]]+)\]/g, function(x){
					x = x.substr(1, x.length-2);
					var idx = groups.length;
					//console.log(x);
					groups.push(x);
					return "#GRP"+idx;
				});
				seq = seq.split(" ");
			}
			//console.log(seq);
			// console.log(groups);
			
			var duration = 1;
			
			var groupSize;
			if(groupMode)
				groupSize = [];
			
			
			var reNote = /([a-g])(((e?s)|(is)|n)?)('*)(\d+)?(@\d+)?/i,
				reChord = /#CH(\d+)/,
				reGroup = /#GRP(\d+)/,
				reBar = /\s*\|[\|\.]?\s*/,
				reEmpty = /^\s*$/,
				reClef = /\$(\d)([#b])/,
				reChordSym = /[ABCDEFG][b#]?[^\:]*\:/,
				reTime = /t(\d)\/(\d)/;
			var notes = $D("c;d;e;f;g;a;b".split(";")).index(function(x, i){return x;}, function(x, i){return i;}).raw();

			function drawNote(paper, note, octave, alt, colorIdx){
				posY = settings.offset.y + settings.staffSize.h - (notes[note]-1)*step/2;
				posY += octave=="'''"?step - 2*settings.staffSize.h
					:octave=="''"?step/2 - 1*settings.staffSize.h
					:octave==""?1*settings.staffSize.h - step/2
					:0;
					
				if(groupSize) groupSize.push({x:posX+3.5, y:posY, dur:duration});
				
				if(posY > settings.offset.y+settings.staffSize.h) signs.addLines(paper, posX, posY, step, settings.offset);
				if(posY < settings.offset.y) signs.addLines(paper, posX, posY, step, settings.offset);
				
				var sign = groupMode?signs.noteHead
					:{1:signs.whole, 2:signs.half, 4:signs.quarter}[duration]; 
				if(sign) sign(paper, posX, posY, colorIdx);
				
				var altSign = {"is":signs.sharp, "s":signs.flat, "es":signs.flat, "n":signs.natural}[alt];
				if(altSign) altSign(paper, posX, posY, colorIdx);
				
				// if(groupMode)
				// 	paper.path(["M", posX+3, posY, "L", posX+3, posY-beamSize]).attr({"stroke-width":1, stroke:settings.signColor});
			}
			
			function drawBeam(){
				//console.log("beam for "+seq.length);
				var iMx = groupSize.length-1;
				paper.path(["M", groupSize[0].x-.5, groupSize[0].y-beamSize, "L", groupSize[iMx].x+.5, groupSize[iMx].y-beamSize]).attr({"stroke-width":2, stroke:settings.signColor});
				// if(duration==16)
				// 	paper.path(["M", groupSize[0].x-.5, groupSize[0].y-beamSize+4, "L", groupSize[iMx].x+.5, groupSize[iMx].y-beamSize+4]).attr({"stroke-width":2, stroke:settings.signColor});
				var bmAng = (groupSize[groupSize.length-1].y - groupSize[0].y)/(groupSize.length-1),
					bmY = groupSize[0].y-beamSize;
				for(var i=0; i<groupSize.length; i++){
					var sz = groupSize[i];
					paper.path(["M", sz.x, sz.y, "L", sz.x, bmY+bmAng*i]).attr({"stroke-width":1, stroke:settings.signColor});
					if(sz.dur==16){
						if(i>0 && groupSize[i-1].dur==16)
							paper.path(["M", groupSize[i-1].x, bmY+bmAng*(i-1)+4, "L", sz.x, bmY+bmAng*i+4]).attr({"stroke-width":2, stroke:settings.signColor});
						else if(i==groupSize.length-1 && groupSize[i-1].dur!=16)
							paper.path(["M", groupSize[i-1].x+stepX*.4, bmY+bmAng*(i-1)*1.6+4, "L", sz.x, bmY+bmAng*i+4]).attr({"stroke-width":2, stroke:settings.signColor});
						else if(i==0 && groupSize[1].dur!=16)
							paper.path(["M", sz.x, bmY+bmAng*i+4, "L", groupSize[1].x-stepX*.4, bmY+bmAng*(i-1)*1.4+1.4]).attr({"stroke-width":2, stroke:settings.signColor});
						
					}
				}
			}

			
			$D.each(seq, function(s, i){
				var mt;
				if(s.match(reEmpty)){
				}
				else if(mt = s.match(reClef)){
					var num = +mt[1],
						sign = mt[2];
					// var signs = "f;c;g;d;a;e;b".split(";");
					var notes = [4,1,5,2,6,3,7];
					if(sign=="#"){
						for(var i=0; i<num; i++){
							var posY = settings.offset.y + settings.staffSize.h - (notes[i]-2)*step/2;
							posY+=step/2 - 1*settings.staffSize.h;
							signs.sharp(paper, posX+10+5*i, posY);
						}
					}
					else if(sign=="b"){
						for(var i=0; i<num; i++){
							var posY = settings.offset.y + settings.staffSize.h - (notes[notes.length-i-1]-1.5)*step/2;
							if(i%2) posY+=step/2 - 1*settings.staffSize.h;
							signs.flat(paper, posX+10+5*i, posY);
						}
					}
					posX+=num*stepX*.2;
				}
				else if(mt = s.match(reTime)){
					var n1 = +mt[1],
						n2 = +mt[2];
					signs["n"+n1](paper, posX+3, settings.offset.y);
					signs["n"+n2](paper, posX+3, settings.offset.y + settings.staffSize.h/2+2);
					posX+=15;
				}
				else if(s.match(reChordSym)){
					var sym = s.replace(":", "");
					paper.text(posX+settings.chordOffset.x, settings.offset.y-settings.chordOffset.y, sym).attr({"stroke-width":0, fill:settings.signColor, "font-size":14});
				}
				else if(s.match(reBar)){
					posX+=15;
					paper.path(["M", posX+.5, settings.offset.y, "L", posX+.5, settings.offset.y + settings.staffSize.h]).attr({stroke:settings.staffColor});
					if(s=="||")
						paper.path(["M", posX+3.5, settings.offset.y, "L", posX+3.5, settings.offset.y + settings.staffSize.h]).attr({stroke:settings.staffColor});
					else if(s=="|.")
						paper.path(["M", posX+4.5, settings.offset.y, "L", posX+4.5, settings.offset.y + settings.staffSize.h]).attr({"stroke-width":4, stroke:settings.staffColor});
				}
				else if(mt = s.match(reChord)){
					posX+=24;
					$D.each(s.split(" "), function(n){
						var cIdx = +n.match(/\d+/);
						var chrd = chords[cIdx];
						var dur = chrd.match(/\d+$/);
						if(dur) duration = +dur;
						chrd = chrd.replace(/^&lt;/, "").replace(/&gt;\d$/, "");
						$D.each(chrd.split(" "), function(nn){
							var mmt = nn.match(/([a-g])((is)|(es)|n)?('*)(@\d+)?/i);
							var note = mmt[1],
								alt = mmt[2],
								octave = mmt[5],
								colorIdx = -1;
							if(mmt[6]){
								colorIdx = parseInt(mmt[6].substr(1));
							}
							drawNote(paper, note, octave, alt, colorIdx);
						});
						
					});
				}
				else if(mt=s.match(reGroup)){
					var gIdx = +mt[1];
					// paper.path(["M", posX, settings.offset.y+15, "L", posX+20, settings.offset.y+15]).attr({"stroke-width":2, stroke:settings.signColor});
					drawSequence(groups[gIdx], true);
				}
				else{
					mt = s.match(reNote);
					if(!mt)
						console.log(s, mt);
					var note = mt[1],
						alt = mt[2]
						octave = mt[6],
						colorIdx = -1;
					if(mt[7])
						duration = +mt[7];
					if(mt[8])
						colorIdx = parseInt(mt[8].substr(1));
					posX += alt?24:15;
					drawNote(paper, note, octave, alt, colorIdx);
				}
			});
			if(groupMode) drawBeam();
		}
		
		drawSequence(staff);
		
	}
	
	$.fn.staff = function(){
		$(this).each(function(i,el){el=$(el);
			var staff = el.html();
			var mt = staff.split("!");
			if(mt.length>1){
				$D.extend(settings, $.parseJSON(mt[0]), true);
				// if(typeof(settings.color)=="string"){
				// 	settings.color = settings.color.split(";");
				// 	settings.color = $D.map(settings.color, function(clr){return "#"+clr;});
				// }
				staff = mt[1];
			}
			else staff = mt[0];
			el.html("");
			init(el, staff);
		});
	};
	
})(jQuery, Raphael, JDB);
